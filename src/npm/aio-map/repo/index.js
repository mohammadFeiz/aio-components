import{divIcon as e}from"leaflet";import{createContext as r,isValidElement as t,useContext as o,useEffect as n,useRef as a,useState as l}from"react";import{Circle as i,FeatureGroup as c,LayersControl as p,MapContainer as s,Marker as m,Polyline as _,Rectangle as d,TileLayer as u,useMapEvents as h}from"react-leaflet";import f from"aio-input";import{JSXToHTML as v}from"aio-utils";import"leaflet/dist/leaflet.css";import"./index.css";import{jsx as $}from"react/jsx-runtime";import{jsxs as M}from"react/jsx-runtime";let MAPCTX=r({}),AIMap=e=>{var r;let{value:t=[35.699939,51.338497],getSearchResult:o,onSearch:i,mapRef:c}=e,[p,s]=l(null),[m,_]=l((null===(r=e.zoom)||void 0===r?void 0:r.value)||14),d=a(!1);function u(e){!0!==d.current&&_(e)}c&&(c.current=p),e.actionsRef&&(e.actionsRef.current={flyTo(e){d.current=!0,p.flyTo([e.lat,e.lng],e.zoom);let r=()=>{p.off("moveend",r),d.current=!1,u(e.zoom),e.callback()};p.on("moveend",r)}});let[h,f]=l(t),v=a(void 0);function g(r){f(r),e.onChange&&(clearTimeout(v.current),v.current=setTimeout(()=>{e.onChange&&e.onChange(r)},600))}function C(){return M("div",{className:"marker-icon",children:[$("div",{className:"marker-icon-circle"}),$("div",{className:"marker-icon-arrow"})]})}function y(){return{pos:h,setMap:s,rootProps:e,move:g,getDefaultMarkerIcon:C,changeZoom:u,zoom:m}}return n(()=>{null!==p&&p.setView(t,m,{animate:!1}),f(t)},[t[0]+"-"+t[1]+"-"+m]),$(MAPCTX.Provider,{value:y(),children:M("div",{className:"ai-map",children:[!!o&&$(MapHeader,{}),$(MapBody,{}),$(MapFooter,{})]})})};export default AIMap;let MapBody=()=>{var e,r;let{rootProps:n,pos:a,setMap:l,getDefaultMarkerIcon:i,zoom:c}=o(MAPCTX),{style:p,dragging:m=!0,children:_,shapes:d=[],marker:h,markers:f=[],whenReady:v}=n,g={width:"100%",height:"100%"};return M(s,{center:a,style:{...g,...p},zoom:c,scrollWheelZoom:null!==(e=n.zoom)&&void 0!==e&&e.wheel?"center":void 0,zoomControl:(null===(r=n.zoom)||void 0===r?void 0:r.control)!==!1,attributionControl:!0,dragging:m,ref:l,whenReady:v,children:[$(u,{url:"https://{s}.tile.openstreetmap.de/{z}/{x}/{y}.png"}),$(MapEvents,{}),!1!==h&&$(MapMarker,{pos:a,html:t(h)?h:i()},"main-marker"),f.map((e,r)=>$(MapMarker,{pos:e.pos,html:e.html,eventHandlers:e.eventHandlers},`marker-${r}`)),d.map((e,r)=>$(MapShape,{shape:e},r)),$(MapLayers,{}),_]})},MagnifyIcon=()=>$("svg",{viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",width:24,height:24,children:$("path",{d:"M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"})}),MapHeader=()=>{let{rootProps:e,move:r}=o(MAPCTX),{getSearchResult:t,onSearch:n}=e,[i,c]=l(""),[p,s]=l([]),m=a();function _(e){c(e),clearTimeout(m.current),m.current=setTimeout(async()=>{if(t){let r=await t(e);Array.isArray(r)&&s(r)}},1200)}return $("div",{className:"ai-map-header",children:$(f,{type:"text",value:i,options:p||[],before:$(MagnifyIcon,{}),onChange:e=>_(e),option:{onClick(e){n&&n(e)}}})})},MapLayers=()=>{let{rootProps:e}=o(MAPCTX),{layers:r}=e;if(!r)return null;let{position:t="topright",items:n=[]}=r;return $(p,{position:t,children:n.map((e,r)=>{let{shapes:t=[],markers:o=[],active:n=!0}=e;return $(p.Overlay,{name:e.name,checked:n,children:M(c,{children:[o.map((e,r)=>$(MapMarker,{pos:e.pos,html:e.html,eventHandlers:e.eventHandlers},r)),t.map((e,r)=>$(MapShape,{shape:e},r))]})},r)})})},MapShape=({shape:e})=>{let{style:r={},type:t}=e,{stroke:o={},fill:n={}}=r,{width:a=4,dash:l,color:c="orange"}=o,{color:p="orange",opacity:s=.3}=n,m={fillColor:p,color:c,fillOpacity:s,weight:a,dashArray:l};if("circle"===t){let{center:u,radius:h=100}=e;return $(i,{center:u,pathOptions:m,radius:h})}return"rect"===t?$(d,{bounds:e.points,pathOptions:m}):"polyline"===t?$(_,{positions:e.points,pathOptions:m}):null},MapFooter=()=>{let{rootProps:e,pos:r}=o(MAPCTX),{submitText:t="Submit",onSubmit:n,footer:a}=e;return n||a?M("div",{className:"ai-map-footer",children:[!!n&&$("button",{type:"button",onClick:()=>n(r),children:t}),$("div",{className:"ai-map-footer-html",children:a||null})]}):null},MapMarker=({pos:r,html:t,eventHandlers:n})=>{let{getDefaultMarkerIcon:a}=o(MAPCTX);function l(r){return e({html:v(r),className:"",iconSize:[32,32],iconAnchor:[16,32]})}t=t||a();let i={position:r};return t&&(i.icon=l(t)),$(m,{...i,animate:!1,eventHandlers:n})};function MapEvents(){let{rootProps:e,move:r,changeZoom:t}=o(MAPCTX);return h({click:()=>e.onClick?e.onClick():void 0,move(t){if(!1===e.dragging)return;let{lat:o,lng:n}=t.target.getCenter();r([o,n])},zoom(e){t(e.target._zoom)},locationfound(e){console.log("location found:",e)},moveend(r){e.onMoveEnd&&e.onMoveEnd(r)},movestart(e){}}),null}