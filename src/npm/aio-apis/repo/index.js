function _defineProperty(e,t,s){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"==typeof t?t:t+""}function _toPrimitive(e,t){if("object"!=typeof e||!e)return e;var s=e[Symbol.toPrimitive];if(void 0!==s){var i=s.call(e,t||"default");if("object"!=typeof i)return i;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}import e from"axios";import t from"aio-popup";import s from"aio-loading";export default class i{constructor(i){_defineProperty(this,"props",void 0),_defineProperty(this,"storage",void 0),_defineProperty(this,"aioLoading",void 0),_defineProperty(this,"popup",void 0),_defineProperty(this,"setToken",t=>{let s=t||this.props.token;s&&(e.defaults.headers.common.Authorization=`Bearer ${s}`)}),_defineProperty(this,"addAlert",e=>{let{type:t,text:s,subtext:i,time:r}=e;"console"===e.messageType?console.log(s,i):"alert"===e.messageType?this.popup.addAlert({type:t,text:s,subtext:i,time:r,className:"aio-apis-popup",closeText:"fa"===this.props.lang?"بستن":"Close"}):this.popup.addSnackebar({type:t,text:s,subtext:i,time:r})}),_defineProperty(this,"renderPopup",()=>this.popup.render()),_defineProperty(this,"setStorage",(e,t)=>this.storage.save(e,t)),_defineProperty(this,"getStorage",(e,t)=>this.storage.load(e,t)),_defineProperty(this,"removeStorage",e=>this.storage.remove(e)),_defineProperty(this,"handleCacheVersions",e=>{let t={};for(let s in e)t[s]=0;let i=this.getStorage("storedCacheVersions",t),r={};for(let o in e)void 0!==i[o]&&(i[o]!==e[o]?(r[o]=!0,this.removeStorage(o)):r[o]=!1);return this.setStorage("storedCacheVersions",e),r}),_defineProperty(this,"responseToResult",async t=>{let{getSuccessResult:s=this.props.getSuccessResult,getErrorMessage:i=this.props.getErrorMessage}=t;if(!i){let r=`
  missing getErrorMessage in api: ${t.description},
  you should set getErrorMessage in api or in props of AIOApis    
`;return alert(r),{success:!1,result:r,response:{}}}if(!s){let o=`
  missing getSuccessResult in api: ${t.description},
  you should set getSuccessResult in api or in props of AIOApis    
`;return alert(o),{success:!1,result:o,response:{}}}try{let a=await e({method:t.method,url:t.url,data:t.body,headers:t.headers}),n=t.isSuccess(a,t);if("string"==typeof n)return{success:!1,result:n,response:a};return{success:!0,result:s(a),response:a}}catch(l){let h=i(l,t);return h||(h=l.message),{success:!1,result:h,response:l}}}),_defineProperty(this,"showErrorMessage",(e,t)=>{let{errorMessageType:s=this.props.errorMessageType||"alert",messageTime:i=this.props.messageTime}=t;if("none"===s)return;let r="fa"===this.props.lang?`${t.description} با خطا روبرو شد`:`An error was occured in ${t.description}`,o=e;this.addAlert({type:"error",text:r,subtext:o,time:i,messageType:s})}),_defineProperty(this,"showSuccessMessage",(e,t,s)=>{let{getSuccessMessage:i=this.props.getSuccessMessage}=s;if(!i)return;let{messageTime:r=this.props.messageTime,successMessageType:o="alert"}=s,a="fa"===this.props.lang?`${s.description} با موفقیت انجام شد`:`${s.description} was successfull`,n=!0===i?"":i(e,t)||"";this.addAlert({type:"success",text:a,subtext:n,time:r,messageType:o})}),_defineProperty(this,"request",async e=>{let{isSuccess:t=this.props.isSuccess||(()=>!0),loading:s=!0,getErrorResult:i=this.props.getErrorResult}=e;if(e.cache){let r=this.storage.load(e.cache.name,void 0,e.cache.time);if(void 0!==r)return r}let o="aa"+Math.round(1e5*Math.random());e.loading&&this.aioLoading.show(o,e.loadingParent);let{success:a,result:n,response:l}=await this.responseToResult({...e,isSuccess:t});if(!a){if(!i){let h=`
  missing getErrorResult in api: ${e.description},
  you should set getErrorResult in api or in props of AIOApis    
`;alert(h);return}return this.showErrorMessage(n,e),i(l)}return this.showSuccessMessage(l,n,e),e.cache&&this.storage.save(e.cache.name,n),s&&this.aioLoading.hide(o),n}),this.props=i,this.aioLoading=new s(i.loader),this.storage=new Storage(i.id),this.popup=new t,this.setToken(i.token)}};class Storage{constructor(e){_defineProperty(this,"model",void 0),_defineProperty(this,"time",void 0),_defineProperty(this,"init",void 0),_defineProperty(this,"saveStorage",void 0),_defineProperty(this,"getParent",void 0),_defineProperty(this,"removeValueByField",void 0),_defineProperty(this,"setValueByField",void 0),_defineProperty(this,"getValueByField",void 0),_defineProperty(this,"save",void 0),_defineProperty(this,"remove",void 0),_defineProperty(this,"load",void 0),_defineProperty(this,"clear",void 0),_defineProperty(this,"getModel",void 0),this.model={},this.time={},this.init=()=>{let t=localStorage.getItem("storageClass"+e),s=localStorage.getItem("storageClassTime"+e),i,r;i=null==t?{}:JSON.parse(t),r=null==s?{}:JSON.parse(s),this.model=i,this.time=r,this.saveStorage(i,r)},this.saveStorage=(t,s)=>{localStorage.setItem("storageClass"+e,JSON.stringify(t)),localStorage.setItem("storageClassTime"+e,JSON.stringify(s))},this.getParent=e=>{let t=e.split("."),s=this.model;for(let i=0;i<t.length-1;i++)if("object"!=typeof(s=s[t[i]]))return;return s},this.removeValueByField=e=>{let t=e.split("."),s=this.getParent(e),i=t[t.length-1],r={};for(let o in s)o!==i&&(r[o]=s[o]);return t.pop(),this.setValueByField(t.join("."),r)},this.setValueByField=(e,t)=>{if(!e){this.model=t;return}var s=e.split("."),i=this.model;for(let r=0;r<s.length-1;r++){let o=s[r];void 0===i[o]&&(i[o]={}),i=i[o]}return i[s[s.length-1]]=t,this.getValueByField(s[0])},this.getValueByField=e=>{let t=e.split("."),s={...this.model};for(let i=0;i<t.length-1;i++)if("object"!=typeof(s=s[t[i]]))return;return s[t[t.length-1]]},this.save=(e,t)=>{try{t=JSON.parse(JSON.stringify(t))}catch{}if(!e||null===e)return{};let s=this.setValueByField(e,t);return this.time[e]=new Date().getTime(),this.saveStorage(this.model,this.time),s},this.remove=(e,t=()=>{})=>{let s=this.removeValueByField(e),i={};for(let r in this.time)r!==e&&(i[r]=this.time[r]);return this.time=i,this.saveStorage(this.model,this.time),t(),s},this.load=(e,t,s)=>{let i=this.getValueByField(e);if(s&&void 0!==i){let r=new Date().getTime(),o=this.time[e]||r;Math.abs(r-o)>s&&(i=void 0)}return void 0===i&&void 0!==t&&(i="function"==typeof t?t():t,this.save(e,t)),i},this.clear=()=>{this.model={},this.time={},this.saveStorage(this.model,this.time)},this.getModel=()=>JSON.parse(JSON.stringify(this.model)),this.init()}}